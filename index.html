<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SEOUL 2026 - 雲端版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <!-- 字體設定 -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@300;400;500;600;700;900&family=Cinzel:wght@400;500;600;700;800;900&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-deep: #050505;
            --gold-primary: #D4AF37;
        }

        /* --- 最高權重強制設定 (移除斜體) --- */
        * { font-style: normal !important; }

        /* 核心字體 */
        body, button, input, select, textarea, .font-zh {
            font-family: 'Cinzel', 'Noto Serif TC', serif !important;
            font-weight: 600;
        }

        /* 英數展示 */
        .font-num, .font-en {
            font-family: 'Cinzel', serif !important;
            letter-spacing: 0.02em;
        }

        /* 韓文專用 */
        .font-kr {
            font-family: 'Noto Sans KR', sans-serif !important;
            letter-spacing: -0.02em;
        }

        /* Placeholder */
        ::placeholder {
            font-family: 'Noto Serif TC', serif !important;
            font-weight: 400;
            opacity: 0.5;
        }
        
        /* 日期與時間輸入框 */
        input[type="date"], input[type="time"] {
            font-family: 'Cinzel', serif !important;
            font-weight: 700 !important;
            min-height: 52px;
            width: 100%;
            -webkit-appearance: none;
            background-color: rgba(35,35,35,0.6);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 0.75rem;
            padding: 0 8px; 
            display: flex;
            align-items: center;
            justify-content: flex-start;
        }

        input[type="date"]::-webkit-date-and-time-value,
        input[type="time"]::-webkit-date-and-time-value { 
            display: inline-block;
            margin: auto 0;
            text-align: left;
            line-height: normal;
        }

        body {
            background-color: var(--bg-deep);
            color: #e5e5e5;
            -webkit-font-smoothing: antialiased;
            background-image: radial-gradient(circle at 50% -10%, #1a1508 0%, #000000 70%);
            background-attachment: fixed;
            height: 100dvh;
            overflow: hidden;
            overscroll-behavior: none;
            position: fixed;
            width: 100%;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* --- 玻璃擬態 --- */
        .glass {
            background: rgba(20, 20, 20, 0.7);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
            position: relative;
            overflow: hidden;
        }
        
        .glass-dock {
            background: rgba(10, 10, 10, 0.92);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 -10px 50px rgba(0,0,0,0.9);
        }

        /* --- 金色流光 --- */
        .text-gold-gradient {
            background: linear-gradient(135deg, #F9F1D0 0%, #D4AF37 40%, #C59D24 60%, #F9F1D0 100%);
            background-size: 200% auto;
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            animation: shine 6s linear infinite;
        }
        @keyframes shine { to { background-position: 200% center; } }

        /* --- 動畫 --- */
        .fade-in { animation: fadeIn 0.5s ease-out forwards; opacity: 0; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        .slide-up { animation: slideUp 0.35s cubic-bezier(0.19, 1, 0.22, 1) forwards; transform: translateY(100%); }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .btn-press:active { transform: scale(0.95); transition: transform 0.1s; }
        
        .pb-safe { padding-bottom: env(safe-area-inset-bottom, 20px); }
        .pt-safe { padding-top: calc(env(safe-area-inset-top) + 24px); }

        .tab-content { display: none; opacity: 0; transition: opacity 0.2s ease; }
        .tab-content.active { display: block; opacity: 1; }

        /* 一般輸入框 */
        input:not([type="date"]):not([type="time"]), select, textarea { 
            color: #fff;
            background-color: rgba(35,35,35,0.6);
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s;
        }
        input:focus, select:focus, textarea:focus {
            border-color: #D4AF37;
            background-color: rgba(15,15,15,0.9);
        }
        
        /* 連結樣式 */
        a.smart-link { color: #D4AF37; border-bottom: 1px dotted rgba(212, 175, 55, 0.5); }
        a.smart-phone { color: #e5e5e5; border-bottom: 1px dotted rgba(255,255,255,0.3); }
        
        .custom-checkbox {
            appearance: none;
            background-color: #27272a;
            border: 1px solid #52525b;
            border-radius: 4px;
            display: grid;
            place-content: center;
        }
        .custom-checkbox::before {
            content: "";
            width: 8px;
            height: 8px;
            transform: scale(0);
            transition: 120ms transform ease-in-out;
            box-shadow: inset 1em 1em #D4AF37;
            transform-origin: center;
            clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
        }
        .custom-checkbox:checked::before { transform: scale(1); }
    </style>
</head>
<body class="flex flex-col text-sm tracking-wide selection:bg-[#D4AF37] selection:text-black">

    <!-- Loading -->
    <div id="loading-screen" class="fixed inset-0 bg-black z-[999] flex flex-col justify-center items-center transition-opacity duration-700">
        <div class="text-gold-gradient text-4xl font-black animate-pulse tracking-[0.2em] font-en">SEOUL</div>
        <div class="h-[1px] w-16 bg-gradient-to-r from-transparent via-[#D4AF37] to-transparent my-3"></div>
        <div class="text-zinc-600 text-[10px] tracking-[0.3em] font-en font-bold uppercase">Connecting</div>
    </div>

    <!-- Header -->
    <header class="pt-safe px-6 pb-2 flex justify-between items-center z-20 flex-shrink-0">
        <div class="flex items-center gap-2.5">
            <h1 class="text-4xl font-black text-white tracking-[0.1em] text-gold-gradient font-en drop-shadow-md">SEOUL</h1>
            <div id="connection-dot" class="w-1.5 h-1.5 rounded-full bg-red-900 shadow-[0_0_5px_currentColor] transition-colors duration-500 mt-1.5"></div>
        </div>
        
        <button onclick="openSubModal('modal-members')" class="w-10 h-10 rounded-full border border-white/10 glass flex items-center justify-center active:scale-95 transition relative hover:border-[#D4AF37]/50">
            <i data-lucide="users" size="18" class="text-zinc-400"></i>
            <div id="user-indicator" class="hidden absolute top-0 right-0 w-2.5 h-2.5 bg-[#D4AF37] rounded-full border-2 border-black"></div>
        </button>
    </header>

    <!-- Main Container -->
    <main class="flex-1 overflow-y-auto no-scrollbar relative pb-32 px-6" id="main-container">
        
        <!-- 0. Dashboard -->
        <div id="view-dashboard" class="tab-content active space-y-5 fade-in">
            <!-- 早安問候 -->
            <div class="mt-3 mb-5">
                <h2 class="text-3xl font-black text-white tracking-wide whitespace-nowrap overflow-hidden text-ellipsis font-zh cursor-pointer leading-relaxed" onclick="openSubModal('modal-members')">
                    早安，<span id="greeting-name" class="text-gold-gradient font-black font-zh">旅人</span>
                    <span id="greeting-hint" class="text-[10px] text-zinc-500 ml-1 font-normal hidden font-zh">(設定)</span>
                </h2>
                <p class="text-zinc-500 text-xs mt-1 tracking-[0.15em] font-bold font-zh">雲端同步中，隨時準備出發。</p>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <!-- Weather -->
                <a href="https://www.google.com/search?q=seoul+weather" target="_blank" class="glass rounded-[2rem] p-6 col-span-2 relative overflow-hidden flex items-center justify-between group active:scale-98 transition min-h-[120px]">
                    <div class="absolute -right-10 -top-10 w-48 h-48 bg-[#D4AF37]/10 rounded-full blur-[60px]"></div>
                    
                    <div class="relative z-10 flex flex-col justify-center h-full gap-1">
                        <div class="flex items-center gap-2">
                            <span class="text-[11px] text-zinc-300 border border-white/10 px-2.5 py-0.5 rounded-full tracking-widest font-bold font-zh bg-white/5">首爾氣象</span>
                        </div>
                        <div id="weather-desc" class="text-xs text-zinc-400 mt-1 font-bold flex items-center gap-1 font-zh opacity-80">
                            連線中... <i data-lucide="external-link" size="10" class="opacity-50"></i>
                        </div>
                    </div>
                    <div id="weather-temp" class="text-5xl font-black text-white relative z-10 font-num tracking-tight drop-shadow-lg">--°C</div>
                </a>

                <!-- Next Destination -->
                <div class="glass rounded-[2rem] p-6 col-span-2 border-l-[4px] border-l-[#D4AF37] relative overflow-hidden shadow-lg">
                    <div class="flex flex-col justify-start mb-4 relative z-10">
                        <div class="flex items-center justify-between mb-1.5">
                            <div class="text-[11px] text-zinc-500 font-bold font-zh tracking-[0.15em]">下一站</div>
                            <div id="dash-next-time" class="text-xs text-[#D4AF37] font-bold font-num bg-[#D4AF37]/10 px-2 py-0.5 rounded"></div>
                        </div>
                        <h3 class="text-2xl text-white font-black truncate w-full font-zh leading-tight" id="dash-next-event">載入中...</h3>
                    </div>
                    <div class="flex gap-3 mt-2 relative z-10">
                         <button onclick="quickTaxi()" class="flex-1 bg-[#D4AF37]/10 border border-[#D4AF37]/40 text-[#D4AF37] text-[11px] py-3 rounded-xl flex items-center justify-center gap-2 font-bold hover:bg-[#D4AF37] hover:text-black transition active:scale-95 shadow-sm">
                            <i data-lucide="car-front" size="16"></i> <span class="font-en tracking-wider">TAXI</span>
                         </button>
                         <button onclick="quickMap()" class="flex-1 bg-zinc-800/80 border border-white/10 text-zinc-300 text-[11px] py-3 rounded-xl flex items-center justify-center gap-2 hover:bg-zinc-700 transition font-bold active:scale-95 shadow-sm">
                            <i data-lucide="map" size="16"></i> <span class="font-en tracking-wider">MAP</span>
                         </button>
                    </div>
                </div>

                <!-- Hotel Info -->
                <div onclick="openNaverMap('Amanti Seoul Hotel')" class="glass rounded-[2rem] p-6 col-span-2 relative overflow-hidden active:scale-98 transition cursor-pointer flex items-center border border-white/5 min-h-[120px]">
                     <div class="absolute right-[-20px] bottom-[-20px] text-white/5 rotate-12">
                         <i data-lucide="hotel" size="120"></i>
                     </div>
                     <div class="relative z-10 w-full flex flex-col gap-2">
                         <div class="flex items-center gap-2 mb-0.5">
                            <div class="w-1.5 h-1.5 bg-blue-500 rounded-full shadow-[0_0_5px_#3b82f6]"></div>
                            <div class="text-[11px] text-blue-400/90 font-bold font-zh tracking-[0.1em]">住宿資訊</div>
                         </div>
                         <h3 class="text-2xl text-white font-black font-en tracking-wide truncate drop-shadow-md">Amanti Seoul Hotel</h3>
                         <div class="text-[11px] text-zinc-500 font-en tracking-wider flex items-center gap-1.5">
                            <i data-lucide="map-pin" size="12"></i> Mapo-gu, Seoul
                         </div>
                     </div>
                </div>

                <!-- Tools Section -->
                <div class="col-span-2 mt-2">
                    <h3 class="text-[11px] text-zinc-500 mb-3 tracking-[0.15em] font-bold font-zh">在地工具</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <a href="https://papago.naver.com/" target="_blank" class="glass p-5 rounded-2xl flex flex-col justify-center gap-3 active:scale-95 transition border border-white/5 hover:bg-[#00c73c]/10 hover:border-[#00c73c]/30 group min-h-[110px] relative overflow-hidden">
                            <div class="absolute -right-5 -bottom-5 w-20 h-20 bg-[#00c73c]/5 rounded-full blur-xl"></div>
                            <div class="w-10 h-10 rounded-full bg-[#00c73c]/10 flex items-center justify-center text-[#00c73c] border border-[#00c73c]/20 shadow-sm z-10"><i data-lucide="languages" size="20"></i></div>
                            <div class="z-10">
                                <div class="text-base text-zinc-200 font-bold font-en group-hover:text-[#00c73c] transition">Papago</div>
                                <div class="text-[10px] text-zinc-500 font-zh mt-0.5 tracking-wide">翻譯神器</div>
                            </div>
                        </a>
                        <a href="http://www.seoulmetro.co.kr/en/cyberStation.do" target="_blank" class="glass p-5 rounded-2xl flex flex-col justify-center gap-3 active:scale-95 transition border border-white/5 hover:bg-[#eab308]/10 hover:border-[#eab308]/30 group min-h-[110px] relative overflow-hidden">
                            <div class="absolute -right-5 -bottom-5 w-20 h-20 bg-[#eab308]/5 rounded-full blur-xl"></div>
                            <div class="w-10 h-10 rounded-full bg-[#eab308]/10 flex items-center justify-center text-[#eab308] border border-[#eab308]/20 shadow-sm z-10"><i data-lucide="train" size="20"></i></div>
                            <div class="z-10">
                                <div class="text-base text-zinc-200 font-bold font-en group-hover:text-[#eab308] transition">Subway</div>
                                <div class="text-[10px] text-zinc-500 font-zh mt-0.5 tracking-wide">地鐵路線</div>
                            </div>
                        </a>
                    </div>
                </div>

                <!-- Memo -->
                <div class="col-span-2 mt-2">
                    <div class="glass p-0.5 rounded-2xl">
                        <textarea id="global-memo" class="w-full bg-transparent border-none rounded-xl p-5 text-zinc-300 text-sm h-32 focus:ring-0 outline-none placeholder-zinc-700 font-zh leading-relaxed resize-none" placeholder="輸入預約代號、重要事項..."></textarea>
                    </div>
                </div>
            </div>
            
            <div class="pb-24"></div>
        </div>

        <!-- 1. Itinerary -->
        <div id="view-itinerary" class="tab-content space-y-6">
            <h2 class="text-3xl font-black text-white tracking-[0.1em] font-zh">行程規劃</h2>
            
            <!-- 日期 Tabs (修正：高度72px，按鈕w-12，有呼吸感，對齊上方標題) -->
            <div class="sticky top-0 z-20 glass rounded-2xl p-2 mb-4 backdrop-blur-md shadow-lg border-b border-[#D4AF37]/10 flex items-center h-[72px]">
                <div class="grid grid-cols-5 gap-1.5 w-full h-full justify-items-center" id="date-tabs"></div>
            </div>
            
            <!-- 行程列表 (修正：移除左側時間軸與點，卡片與上方日期框等寬) -->
            <div id="itinerary-list" class="space-y-3 pb-24"></div>
        </div>

        <!-- 2. Packing -->
        <div id="view-packing" class="tab-content space-y-6">
            <h2 class="text-3xl font-black text-white tracking-[0.1em] font-zh">行李清單</h2>
            
            <div class="glass rounded-[2rem] p-6 flex items-center gap-6 border-t border-white/10">
                <div class="relative w-24 h-24 flex-shrink-0 flex items-center justify-center">
                    <svg class="transform -rotate-90 w-24 h-24">
                        <circle cx="48" cy="48" r="42" stroke="#1f1f1f" stroke-width="3" fill="transparent" />
                        <circle id="pack-ring" cx="48" cy="48" r="42" stroke="url(#grad1)" stroke-width="3" fill="transparent" stroke-dasharray="264" stroke-dashoffset="264" class="transition-all duration-1000 ease-out" stroke-linecap="round" />
                        <defs><linearGradient id="grad1"><stop offset="0%" stop-color="#b38728"/><stop offset="100%" stop-color="#fcf6ba"/></linearGradient></defs>
                    </svg>
                    <span id="pack-percent" class="absolute text-xl font-black text-white font-num">0%</span>
                </div>
                <div>
                    <div class="text-lg text-white font-bold tracking-wide font-zh">打包進度</div>
                    <div class="text-xs text-zinc-500 mt-1 leading-relaxed font-zh">出發前請再次確認<br>護照與錢包。</div>
                </div>
            </div>
            <div id="packing-list" class="space-y-4 pb-24"></div>
        </div>

        <!-- 3. Expenses -->
        <div id="view-expenses" class="tab-content space-y-6">
            <h2 class="text-3xl font-black text-white tracking-[0.1em] font-zh">旅費分帳</h2>
            
            <div class="w-full aspect-[1.8/1] rounded-[2rem] bg-gradient-to-br from-[#1c1c1c] via-black to-[#050505] border border-[#D4AF37]/20 p-7 relative overflow-hidden shadow-xl flex flex-col justify-between">
                <div class="absolute -right-10 -top-10 w-48 h-48 bg-[#D4AF37]/10 rounded-full blur-[60px]"></div>
                <div class="flex justify-between items-start z-10">
                    <i data-lucide="nfc" class="text-zinc-600 rotate-90" size="24"></i>
                    <span class="text-[9px] text-[#D4AF37] tracking-[0.2em] font-bold font-en border border-[#D4AF37]/20 px-2 py-0.5 rounded">SEOUL PASS</span>
                </div>
                <div class="z-10 pl-1">
                    <div class="text-[10px] text-zinc-500 uppercase tracking-[0.2em] mb-1 font-bold font-en">Total Amount</div>
                    <!-- 緊湊字距 -->
                    <div id="total-expense" class="text-4xl font-bold text-white tracking-tight text-shadow-sm font-num text-[#D4AF37]">NT$ 0</div>
                </div>
                <div class="flex justify-between items-end z-10 border-t border-white/10 pt-4">
                    <div class="text-[9px] text-zinc-600 tracking-[0.2em] font-bold font-en">**** 2026</div>
                    <div class="text-[9px] text-[#D4AF37]/80 italic font-en">Group Split</div>
                </div>
            </div>

            <div class="glass rounded-t-[2.5rem] min-h-[45vh] p-6 -mt-6 border-t border-white/5 relative z-0 backdrop-blur-xl">
                <div class="w-10 h-1 bg-zinc-700 rounded-full mx-auto mb-6"></div>
                <div class="flex justify-between items-center mb-5">
                    <h3 class="text-xs font-bold text-zinc-500 tracking-widest font-zh">近期支出</h3>
                    <div class="flex gap-2">
                        <button onclick="copySettlement()" class="text-[10px] text-zinc-400 hover:text-white transition bg-zinc-800 border border-zinc-700 px-4 py-2 rounded-full font-bold flex items-center gap-1.5 active:scale-95 font-zh">
                            <i data-lucide="copy" size="12"></i> 複製
                        </button>
                        <button onclick="toggleSettlement()" class="text-[10px] text-[#D4AF37] hover:text-[#fff] transition bg-[#D4AF37]/10 border border-[#D4AF37]/20 px-4 py-2 rounded-full font-bold font-zh active:scale-95">
                            結算
                        </button>
                    </div>
                </div>
                <div id="settlement-view" class="hidden mb-5 bg-black/40 rounded-xl p-5 border border-zinc-800 shadow-inner">
                    <div id="split-result" class="text-xs text-zinc-300 space-y-2.5 font-bold leading-loose text-center font-zh"></div>
                </div>
                <div id="expense-list" class="space-y-3 pb-24"></div>
            </div>
        </div>
    </main>

    <!-- Navigation Dock -->
    <nav class="fixed bottom-6 left-5 right-5 h-[76px] glass-dock rounded-[2.5rem] flex justify-between items-center px-6 z-40 border border-[#D4AF37]/10 shadow-[0_10px_40px_rgba(0,0,0,0.9)]">
        <button onclick="switchTab('view-dashboard', this)" class="nav-btn text-[#D4AF37] transition-all active:scale-90 flex flex-col items-center gap-1 w-10 group">
            <i data-lucide="layout-grid" size="22" class="group-hover:drop-shadow-[0_0_5px_rgba(212,175,55,0.6)]"></i>
            <span class="text-[10px] font-bold tracking-widest font-zh scale-90">首頁</span>
        </button>
        <button onclick="switchTab('view-itinerary', this)" class="nav-btn text-zinc-600 transition-all active:scale-90 flex flex-col items-center gap-1 w-10 hover:text-zinc-300">
            <i data-lucide="calendar" size="22"></i>
            <span class="text-[10px] font-bold tracking-widest font-zh scale-90">行程</span>
        </button>
        <button onclick="openActionSheet()" class="btn-press -mt-12 w-16 h-16 bg-gradient-to-tr from-[#8a7020] via-[#D4AF37] to-[#F9F1D0] rounded-[1.8rem] rotate-45 flex items-center justify-center shadow-[0_5px_25px_rgba(212,175,55,0.3)] border-2 border-[#fff]/10 z-50 transition-all hover:scale-105 active:scale-95 group">
            <i data-lucide="plus" class="text-black -rotate-45" size="30" stroke-width="2.5"></i>
        </button>
        <button onclick="switchTab('view-expenses', this)" class="nav-btn text-zinc-600 transition-all active:scale-90 flex flex-col items-center gap-1 w-10 hover:text-zinc-300">
            <i data-lucide="credit-card" size="22"></i>
            <span class="text-[10px] font-bold tracking-widest font-zh scale-90">帳務</span>
        </button>
        <button onclick="switchTab('view-packing', this)" class="nav-btn text-zinc-600 transition-all active:scale-90 flex flex-col items-center gap-1 w-10 hover:text-zinc-300">
            <i data-lucide="backpack" size="22"></i>
            <span class="text-[10px] font-bold tracking-widest font-zh scale-90">行李</span>
        </button>
    </nav>

    <!-- Taxi Mode (V1 Style + Copy Button) -->
    <div id="taxi-overlay" class="fixed inset-0 bg-black z-[100] hidden flex-col justify-center items-center p-8 text-center">
        <button onclick="closeTaxiMode()" class="absolute top-8 right-8 text-zinc-500 p-4 active:scale-90 transition"><i data-lucide="x" size="32"></i></button>
        
        <div class="text-[#D4AF37] text-xs tracking-[0.4em] font-black mb-12 animate-pulse font-en border-b border-[#D4AF37]/50 pb-3">TAXI MODE</div>
        
        <div class="text-zinc-500 text-lg mb-6 font-kr font-medium">기사님, 여기로 가주세요</div>
        <div id="taxi-kor-title" class="text-white text-5xl font-black mb-10 font-kr leading-snug px-4 break-keep"></div>
        
        <div class="w-full h-[1px] bg-zinc-800 mb-10"></div>
        
        <div id="taxi-kor-addr" class="text-zinc-300 text-2xl font-kr font-bold leading-relaxed mb-12 px-4 break-keep"></div>
        
        <button onclick="copyTaxiAddr()" class="flex items-center gap-3 bg-[#1a1a1a] text-[#D4AF37] px-8 py-4 rounded-full font-bold active:scale-95 transition border border-[#D4AF37]/40 shadow-[0_0_30px_rgba(212,175,55,0.15)] group">
            <i data-lucide="copy" size="20" class="group-hover:scale-110 transition"></i> 
            <span class="font-zh text-base">複製韓文地址</span>
        </button>
    </div>

    <!-- Action Sheet -->
    <div id="action-sheet-overlay" class="fixed inset-0 bg-black/60 backdrop-blur-md z-50 hidden opacity-0 transition-opacity duration-300" onclick="closeActionSheet()"></div>
    <div id="action-sheet" class="fixed bottom-0 left-0 right-0 bg-[#0f0f0f] rounded-t-[2.5rem] p-7 z-50 transform translate-y-full transition-transform duration-300 border-t border-white/10 shadow-2xl pb-12">
        <div class="w-10 h-1 bg-zinc-800 rounded-full mx-auto mb-8"></div>
        <div class="grid grid-cols-3 gap-5 mb-6">
            <button onclick="window.openAddEvent()" class="flex flex-col items-center gap-2.5 p-5 bg-zinc-900/60 rounded-[2rem] border border-zinc-800 active:scale-95 transition">
                <div class="w-14 h-14 rounded-full bg-zinc-800 text-zinc-400 flex items-center justify-center border border-white/5"><i data-lucide="map-pin" size="24"></i></div>
                <span class="text-[11px] text-zinc-400 font-bold font-zh tracking-wider">新行程</span>
            </button>
            <button onclick="openSubModal('modal-expense')" class="flex flex-col items-center gap-2.5 p-5 bg-zinc-900/60 rounded-[2rem] border border-zinc-800 active:scale-95 transition">
                <div class="w-14 h-14 rounded-full bg-zinc-800 text-zinc-400 flex items-center justify-center border border-white/5"><i data-lucide="receipt" size="24"></i></div>
                <span class="text-[11px] text-zinc-400 font-bold font-zh tracking-wider">記一筆</span>
            </button>
            <button onclick="openSubModal('modal-packing')" class="flex flex-col items-center gap-2.5 p-5 bg-zinc-900/60 rounded-[2rem] border border-zinc-800 active:scale-95 transition">
                <div class="w-14 h-14 rounded-full bg-zinc-800 text-zinc-400 flex items-center justify-center border border-white/5"><i data-lucide="backpack" size="24"></i></div>
                <span class="text-[11px] text-zinc-400 font-bold font-zh tracking-wider">加物品</span>
            </button>
        </div>
        <button onclick="closeActionSheet()" class="w-full py-4 text-zinc-600 text-xs tracking-[0.2em] font-bold font-zh">取消</button>
    </div>

    <!-- Modals -->
    <div id="modal-container" class="fixed inset-0 z-[60] hidden flex items-center justify-center px-6 bg-black/80 backdrop-blur-md transition-opacity">
        
        <!-- Itinerary Modal (Fix: Gap 2 & Padding 8px) -->
        <div id="modal-itinerary" class="hidden w-full max-w-sm glass rounded-[2rem] p-6 shadow-2xl slide-up max-h-[90vh] overflow-y-auto border border-zinc-800">
            <div class="flex justify-between items-center mb-6 border-b border-white/10 pb-4">
                <h3 id="modal-itinerary-title" class="text-xl text-white font-bold font-zh tracking-wide">新增行程</h3>
                <button id="btn-delete-event" onclick="deleteCurrentEvent()" class="text-red-500/70 hover:text-red-500 hidden"><i data-lucide="trash-2" size="20"></i></button>
            </div>
            <div class="space-y-4">
                <div class="flex gap-2"> 
                    <div class="flex-1">
                        <label class="block text-[11px] text-zinc-500 mb-1.5 font-bold font-zh">日期</label>
                        <input type="date" id="evt-date" class="w-full rounded-xl text-sm bg-zinc-900/80 border-zinc-800 focus:border-[#D4AF37]">
                    </div>
                    <div class="flex-1">
                        <label class="block text-[11px] text-zinc-500 mb-1.5 font-bold font-zh">時間</label>
                        <input type="time" id="evt-time" class="w-full rounded-xl text-sm bg-zinc-900/80 border-zinc-800 focus:border-[#D4AF37]">
                    </div>
                </div>
                
                <input type="text" id="evt-title" placeholder="地點名稱 (中文)" class="w-full bg-zinc-900/80 border border-zinc-800 rounded-xl p-4 text-white outline-none font-zh font-bold text-sm focus:border-[#D4AF37]/80">
                <input type="text" id="evt-kor-title" placeholder="地點名稱 (韓文)" class="w-full bg-zinc-900/80 border border-zinc-800 rounded-xl p-4 text-white outline-none font-kr font-bold text-sm focus:border-[#D4AF37]/80">
                <input type="text" id="evt-kor-addr" placeholder="地址 (韓文)" class="w-full bg-zinc-900/80 border border-zinc-800 rounded-xl p-4 text-white outline-none font-kr font-bold text-sm focus:border-[#D4AF37]/80">
                <textarea id="evt-memo" placeholder="備忘錄..." class="w-full bg-zinc-900/80 border border-zinc-800 rounded-xl p-4 text-white outline-none font-zh font-bold text-sm focus:border-[#D4AF37]/80 resize-none h-24"></textarea>
            </div>
            <div class="flex gap-4 mt-8">
                <button onclick="closeSubModal()" class="flex-1 py-4 rounded-xl bg-zinc-900 text-zinc-400 font-bold font-zh text-sm">取消</button>
                <button onclick="window.saveEvent()" class="flex-1 py-4 rounded-xl bg-[#D4AF37] text-black font-bold font-zh text-sm">儲存</button>
            </div>
        </div>

        <!-- Expense Modal (FIX: Scrollable) -->
        <div id="modal-expense" class="hidden w-full max-w-sm glass rounded-[2rem] p-6 shadow-2xl slide-up max-h-[90vh] overflow-y-auto border border-zinc-800">
            <h3 class="text-xl text-white font-bold mb-6 border-b border-white/10 pb-4 font-zh tracking-wide">新增支出</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-[11px] text-zinc-500 mb-1.5 font-bold font-zh">付款人</label>
                    <div class="relative">
                        <select id="exp-payer" class="w-full bg-zinc-900/80 border border-zinc-800 rounded-xl p-4 text-white outline-none font-bold font-zh text-sm appearance-none">
                        </select>
                        <i data-lucide="chevron-down" size="16" class="absolute right-4 top-5 text-zinc-500 pointer-events-none"></i>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-[11px] text-zinc-500 mb-1.5 font-bold font-zh">韓幣 (KRW)</label>
                        <input type="number" id="exp-amount-krw" placeholder="₩" class="w-full bg-zinc-900/80 border border-zinc-800 rounded-xl p-4 text-white outline-none font-bold font-num text-sm" oninput="convertExpense('krw')">
                    </div>
                    <div>
                        <label class="block text-[11px] text-zinc-500 mb-1.5 font-bold font-zh">台幣 (TWD)</label>
                        <input type="number" id="exp-amount" placeholder="$" class="w-full bg-zinc-900/80 border border-zinc-800 rounded-xl p-4 text-white outline-none font-bold font-num text-sm" oninput="convertExpense('twd')">
                    </div>
                </div>
                <div class="text-[10px] text-[#D4AF37]/80 text-right -mt-1 pr-1 font-num" id="rate-display-text">--</div>

                <input type="text" id="exp-desc" placeholder="項目" class="w-full bg-zinc-900/80 border border-zinc-800 rounded-xl p-4 text-white outline-none font-bold font-zh text-sm">
                <div class="bg-zinc-900/40 p-4 rounded-xl border border-zinc-800/50">
                    <label class="text-[11px] text-zinc-500 mb-3 block font-bold font-zh">分攤成員</label>
                    <div class="grid grid-cols-2 gap-3" id="exp-members"></div>
                </div>
            </div>
            <div class="flex gap-4 mt-8">
                <button onclick="closeSubModal()" class="flex-1 py-4 rounded-xl bg-zinc-900 text-zinc-400 font-bold font-zh text-sm">取消</button>
                <button onclick="window.addExpense()" class="flex-1 py-4 rounded-xl bg-[#D4AF37] text-black font-bold font-zh text-sm">儲存</button>
            </div>
        </div>

        <!-- NEW: Expense Detail Modal -->
        <div id="modal-expense-detail" class="hidden w-full max-w-sm glass rounded-[2rem] p-6 shadow-2xl slide-up max-h-[80vh] overflow-y-auto border border-zinc-800">
            <div class="text-center mb-6">
                 <div class="text-[10px] text-zinc-500 tracking-widest font-zh mb-2">帳務詳情</div>
                 <div id="detail-amount" class="text-4xl text-[#D4AF37] font-black font-num"></div>
                 <div id="detail-desc" class="text-xl text-white font-bold font-zh mt-2"></div>
            </div>
            
            <div class="bg-zinc-900/40 rounded-xl p-5 border border-zinc-800 space-y-4">
                 <div class="flex justify-between items-center border-b border-white/5 pb-3">
                     <span class="text-xs text-zinc-500 font-zh">付款人</span>
                     <span id="detail-payer" class="text-sm text-white font-bold font-zh"></span>
                 </div>
                 <div>
                     <div class="text-xs text-zinc-500 font-zh mb-2">分攤成員</div>
                     <div id="detail-members" class="flex flex-wrap gap-2"></div>
                 </div>
            </div>

            <div class="flex gap-4 mt-8">
                <button onclick="closeSubModal()" class="flex-1 py-4 rounded-xl bg-zinc-900 text-zinc-400 font-bold font-zh text-sm">關閉</button>
                <button id="btn-delete-expense" class="flex-1 py-4 rounded-xl bg-red-900/20 text-red-500 border border-red-900/50 font-bold font-zh text-sm hover:bg-red-900/40">刪除</button>
            </div>
        </div>

        <!-- Packing Modal -->
        <div id="modal-packing" class="hidden w-full max-w-sm glass rounded-[2rem] p-6 shadow-2xl slide-up">
            <h3 class="text-xl text-white font-bold mb-6 border-b border-white/10 pb-4 font-zh tracking-wide">新增行李</h3>
            <div class="space-y-4">
                <div class="relative">
                    <select id="pack-cat" class="w-full bg-zinc-900/80 border border-zinc-800 rounded-xl p-4 text-white outline-none font-bold font-zh text-sm appearance-none">
                        <option value="證件金錢">證件金錢</option>
                        <option value="電子產品">電子產品</option>
                        <option value="衣物">衣物</option>
                        <option value="盥洗/藥品">盥洗/藥品</option>
                        <option value="其他">其他</option>
                    </select>
                    <i data-lucide="chevron-down" size="16" class="absolute right-4 top-5 text-zinc-500 pointer-events-none"></i>
                </div>
                <input type="text" id="pack-item" placeholder="物品名稱" class="w-full bg-zinc-900/80 border border-zinc-800 rounded-xl p-4 text-white outline-none font-bold font-zh text-sm">
            </div>
            <div class="flex gap-4 mt-8">
                <button onclick="closeSubModal()" class="flex-1 py-4 rounded-xl bg-zinc-900 text-zinc-400 font-bold font-zh text-sm">取消</button>
                <button onclick="window.addPackItem()" class="flex-1 py-4 rounded-xl bg-[#D4AF37] text-black font-bold font-zh text-sm">儲存</button>
            </div>
        </div>

        <!-- Members Modal (FIX: Button layout) -->
        <div id="modal-members" class="hidden w-full max-w-sm glass rounded-[2rem] p-6 shadow-2xl slide-up">
            <h3 class="text-xl text-white font-bold mb-6 border-b border-white/10 pb-4 font-zh tracking-wide">人員管理</h3>
            <div class="space-y-5">
                <div class="flex gap-3 items-stretch">
                    <input type="text" id="new-member-name" placeholder="輸入名字" class="flex-1 min-w-0 bg-zinc-900/80 border border-zinc-800 rounded-xl px-4 text-white outline-none font-bold font-zh text-sm focus:border-[#D4AF37]/80 h-12">
                    <button onclick="window.addMember()" class="px-6 flex-none bg-[#D4AF37] text-black rounded-xl font-bold font-zh text-sm shadow-md whitespace-nowrap h-12 hover:scale-105 transition">新增</button>
                </div>
                <div id="members-list" class="space-y-2 max-h-48 overflow-y-auto pr-1"></div>
            </div>
            <div class="flex gap-4 mt-8">
                <button onclick="closeSubModal()" class="w-full py-4 rounded-xl bg-zinc-800 text-zinc-400 font-bold font-zh text-sm hover:text-white">關閉</button>
            </div>
        </div>
    </div>

    <!-- Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAm35dBdL6MuVD_pcBDNOTjsJtTR7O8OkU",
            authDomain: "seoul-7f4a8.firebaseapp.com",
            projectId: "seoul-7f4a8",
            storageBucket: "seoul-7f4a8.firebasestorage.app",
            messagingSenderId: "653079863838",
            appId: "1:653079863838:web:cce154e2a44793b171c40f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        const TRIP_ID = "trip_data_2026_v3_final"; 

        const defaultData = {
            itinerary: {
                "2026-03-18": [], "2026-03-19": [], "2026-03-20": [], "2026-03-21": [], "2026-03-22": []
            },
            packing: [], expenses: [], memo: "", members: ["我"]
        };

        let appData = defaultData;
        let currentDay = "2026-03-18";
        let editingContext = null;
        let currentRate = 0.024; 

        async function init() {
            try {
                await signInAnonymously(auth);
                const dot = document.getElementById('connection-dot');
                if(dot) dot.className = "w-1.5 h-1.5 rounded-full bg-yellow-500 shadow-[0_0_8px_currentColor] transition-colors duration-500 mt-1.5";

                fetchExchangeRate();

                onSnapshot(doc(db, "trips", TRIP_ID), (docSnap) => {
                    if (docSnap.exists()) {
                        appData = docSnap.data();
                    } else {
                        saveDataToFirebase();
                    }
                    renderAll();
                    fetchWeather();
                    
                    if(dot) dot.className = "w-1.5 h-1.5 rounded-full bg-[#00ff41] shadow-[0_0_8px_#00ff41] transition-colors duration-500 mt-1.5";
                    
                    const loader = document.getElementById('loading-screen');
                    loader.style.opacity = 0;
                    setTimeout(() => loader.style.display = 'none', 700);
                }, (error) => {
                    if(dot) dot.className = "w-1.5 h-1.5 rounded-full bg-red-600 shadow-[0_0_8px_red] transition-colors duration-500 mt-1.5";
                });
            } catch (error) {
                console.error("Firebase Init Error:", error);
                document.getElementById('loading-screen').style.display = 'none';
            }
        }

        async function fetchExchangeRate() {
            try {
                const res = await fetch('https://api.exchangerate-api.com/v4/latest/KRW');
                const data = await res.json();
                if(data && data.rates && data.rates.TWD) {
                    currentRate = data.rates.TWD;
                    const rateDisplay = document.getElementById('rate-display-text');
                    if(rateDisplay) rateDisplay.innerText = `匯率: ${currentRate.toFixed(4)}`;
                }
            } catch(e) { console.warn("Rate fetch failed"); }
        }

        async function fetchWeather() {
            try {
                const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=37.5665&longitude=126.9780&current_weather=true&timezone=Asia%2FSeoul');
                const data = await res.json();
                if(data && data.current_weather) {
                    const temp = Math.round(data.current_weather.temperature);
                    const code = data.current_weather.weathercode;
                    let desc = "晴朗";
                    if (code >= 1 && code <= 3) { desc = "多雲"; }
                    else if (code >= 51 && code <= 67) { desc = "有雨"; }
                    else if (code >= 71) { desc = "降雪"; }
                    
                    document.getElementById('weather-temp').innerText = `${temp}°C`;
                    document.getElementById('weather-desc').innerHTML = `${desc} <i data-lucide="external-link" size="10" class="opacity-50"></i>`;
                }
            } catch (e) { console.error("Weather fetch failed"); }
        }

        async function saveDataToFirebase() {
            try { await setDoc(doc(db, "trips", TRIP_ID), appData); } catch (e) { console.error("Save failed: ", e); }
        }

        window.saveData = saveDataToFirebase;

        window.addMember = () => {
            const name = document.getElementById('new-member-name').value.trim();
            if(name && !appData.members.includes(name)) {
                appData.members.push(name);
                document.getElementById('new-member-name').value = '';
                saveDataToFirebase();
            }
        };

        window.setAsMe = (name) => {
            localStorage.setItem('korea_travel_me', name);
            updateDashboard();
            window.renderMembers(); 
        };

        window.removeMember = (name) => {
            if(confirm(`確定移除 ${name}?`)) {
                appData.members = appData.members.filter(m => m !== name);
                saveDataToFirebase();
            }
        };

        window.saveEvent = () => {
            const date = document.getElementById('evt-date').value;
            const time = document.getElementById('evt-time').value;
            const title = document.getElementById('evt-title').value;
            const korTitle = document.getElementById('evt-kor-title').value;
            const korAddr = document.getElementById('evt-kor-addr').value;
            const memo = document.getElementById('evt-memo').value;

            if(date && time && title) {
                if (editingContext) {
                     appData.itinerary[editingContext.date].splice(editingContext.index, 1);
                }
                if (!appData.itinerary[date]) appData.itinerary[date] = [];

                appData.itinerary[date].push({time, title, korTitle, korAddr, memo});
                appData.itinerary[date].sort((a,b) => a.time.localeCompare(b.time));
                
                saveDataToFirebase();
                currentDay = date; 
                closeSubModal();
                renderItinerary(); 
            } else {
                alert("請填寫日期、時間和名稱");
            }
        };

        window.deleteCurrentEvent = () => {
            if(editingContext && confirm('確定要刪除此行程？')) {
                appData.itinerary[editingContext.date].splice(editingContext.index, 1);
                saveDataToFirebase();
                closeSubModal();
            }
        };
        
        window.openEditEvent = (index) => {
            const event = appData.itinerary[currentDay][index];
            if (!event) return;
            editingContext = { date: currentDay, index: index };
            
            document.getElementById('modal-itinerary-title').innerText = "編輯行程";
            document.getElementById('btn-delete-event').classList.remove('hidden');
            document.getElementById('evt-date').value = currentDay;
            document.getElementById('evt-time').value = event.time;
            document.getElementById('evt-title').value = event.title;
            document.getElementById('evt-kor-title').value = event.korTitle || "";
            document.getElementById('evt-kor-addr').value = event.korAddr || "";
            document.getElementById('evt-memo').value = event.memo || "";
            openSubModal('modal-itinerary', true); 
        };

        window.openAddEvent = () => {
            editingContext = null;
            document.getElementById('modal-itinerary-title').innerText = "新增行程";
            document.getElementById('btn-delete-event').classList.add('hidden');
            document.getElementById('evt-date').value = currentDay;
            document.getElementById('evt-time').value = "";
            document.getElementById('evt-title').value = "";
            document.getElementById('evt-kor-title').value = "";
            document.getElementById('evt-kor-addr').value = "";
            document.getElementById('evt-memo').value = "";
            openSubModal('modal-itinerary', true);
        };

        window.addExpense = () => {
            const payer = document.getElementById('exp-payer').value;
            const amount = document.getElementById('exp-amount').value;
            const desc = document.getElementById('exp-desc').value;
            const checkboxes = document.querySelectorAll('#exp-members input:checked');
            const selectedMembers = Array.from(checkboxes).map(cb => cb.value);
            if(payer && amount && selectedMembers.length > 0) {
                appData.expenses.push({payer, amount, desc, members: selectedMembers});
                saveDataToFirebase();
                closeSubModal();
            } else {
                alert("請填寫完整資訊並選擇分攤成員");
            }
        };

        // 新增：打開帳務詳情
        window.openExpenseDetail = (index) => {
             const exp = appData.expenses[index];
             if(!exp) return;
             
             document.getElementById('detail-amount').innerText = `NT$ ${Number(exp.amount).toLocaleString()}`;
             document.getElementById('detail-desc').innerText = exp.desc;
             document.getElementById('detail-payer').innerText = exp.payer;
             
             // 渲染分攤成員
             const membersHtml = (exp.members || []).map(m => 
                 `<span class="bg-zinc-800 text-zinc-300 text-[10px] px-2 py-1 rounded font-zh border border-white/5">${m}</span>`
             ).join('');
             document.getElementById('detail-members').innerHTML = membersHtml;
             
             // 綁定刪除按鈕
             const delBtn = document.getElementById('btn-delete-expense');
             delBtn.onclick = () => {
                 if(confirm('確定刪除此筆支出？')) {
                     appData.expenses.splice(index, 1);
                     saveDataToFirebase();
                     closeSubModal();
                 }
             };
             
             openSubModal('modal-expense-detail', true);
        };

        window.deleteExp = (i) => {
            appData.expenses.splice(i, 1);
            saveDataToFirebase();
        };

        window.togglePack = (id) => {
            const item = appData.packing.find(i => i.id === id);
            if(item) { item.checked = !item.checked; saveDataToFirebase(); }
        };

        window.addPackItem = () => {
            const cat = document.getElementById('pack-cat').value;
            const name = document.getElementById('pack-item').value;
            if(name) {
                appData.packing.push({id: Date.now(), cat, name, checked: false});
                saveDataToFirebase();
                closeSubModal();
            }
        };

        window.deletePack = (id) => {
            appData.packing = appData.packing.filter(i => i.id !== id);
            saveDataToFirebase();
        };

        window.setDay = (d) => {
            currentDay = d;
            renderItinerary();
        };

        window.convertExpense = (source) => {
            const krwEl = document.getElementById('exp-amount-krw');
            const twdEl = document.getElementById('exp-amount');
            
            if(source === 'krw') {
                const val = parseFloat(krwEl.value);
                if(!isNaN(val)) {
                    twdEl.value = Math.round(val * currentRate);
                } else {
                    twdEl.value = '';
                }
            } else {
                const val = parseFloat(twdEl.value);
                if(!isNaN(val)) {
                    krwEl.value = Math.round(val / currentRate);
                } else {
                    krwEl.value = '';
                }
            }
        }

        window.autoLink = (text) => {
            if(!text) return '';
            let safeText = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            safeText = safeText.replace(urlRegex, (url) => {
                return `<a href="${url}" target="_blank" class="smart-link">${url}</a>`;
            });
            const phoneRegex = /(?:\+?(\d{1,3}))?[-. (]*(\d{2,4})[-. )]*(\d{3,4})[-. ]*(\d{4})/g;
            return safeText.replace(phoneRegex, (match) => {
                if (safeText.includes(`href="${match}"`) || safeText.includes(`>${match}</a>`)) return match;
                return `<a href="tel:${match.replace(/\D/g,'')}" class="smart-phone">${match}</a>`;
            });
        };

        window.copySettlement = () => {
            let total = 0;
            let balances = {};
            if (appData.members) { appData.members.forEach(m => balances[m] = 0); }
            (appData.expenses || []).forEach(e => {
                total += Number(e.amount);
                const share = e.amount / (e.members ? e.members.length : 1);
                if(balances[e.payer] !== undefined) balances[e.payer] += Number(e.amount);
                if(e.members) { e.members.forEach(m => { if(balances[m] !== undefined) balances[m] -= share; }); }
            });
            let text = `🇰🇷 SEOUL 2026 - 結算報表\n------------------------\n💰 總支出: NT$ ${total.toLocaleString()}\n\n[結算結果]\n`;
            let hasResult = false;
            Object.keys(balances).forEach(p => {
                const val = Math.round(balances[p]);
                if(val > 0) { text += `🟩 ${p}: 應收 $${val.toLocaleString()}\n`; hasResult = true; }
                else if(val < 0) { text += `🟥 ${p}: 應付 $${Math.abs(val).toLocaleString()}\n`; hasResult = true; }
            });
            if(!hasResult) text += "目前沒有欠款或支出紀錄。\n";
            text += `------------------------\nGenerated by Seoul App`;
            navigator.clipboard.writeText(text).then(() => alert("✅ 結算報表已複製！"));
        };

        window.copyTaxiAddr = () => {
            const addr = document.getElementById('taxi-kor-addr').innerText;
            if(addr) {
                if (navigator.clipboard && window.isSecureContext) {
                     navigator.clipboard.writeText(addr).then(() => alert("✅ 地址已複製"));
                } else {
                    // Fallback
                    const textArea = document.createElement("textarea");
                    textArea.value = addr;
                    textArea.style.position = "fixed"; 
                    textArea.style.left = "-9999px";
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        alert("✅ 地址已複製");
                    } catch (err) {
                        alert("複製失敗，請手動複製");
                    }
                    document.body.removeChild(textArea);
                }
            }
        }

        window.renderMembers = () => {
            const list = document.getElementById('members-list');
            const currentMe = localStorage.getItem('korea_travel_me');
            if (list) {
                list.innerHTML = appData.members.map(m => `
                    <div class="flex justify-between items-center bg-zinc-800/80 p-3 rounded-xl border border-white/5 group hover:border-[#D4AF37]/50 transition">
                        <div class="flex items-center gap-3">
                            <span class="text-zinc-200 font-bold font-zh text-sm">${m}</span>
                            ${m !== currentMe ? `<button onclick="window.setAsMe('${m}')" class="text-[10px] bg-zinc-700 px-2 py-1 rounded text-zinc-400 hover:bg-[#D4AF37] hover:text-black transition font-zh">設為我</button>` : '<span class="text-[10px] text-[#D4AF37] font-bold font-zh"> (我)</span>'}
                        </div>
                        <button onclick="window.removeMember('${m}')" class="text-zinc-600 hover:text-red-500 transition p-2"><i data-lucide="trash-2" size="16"></i></button>
                    </div>
                `).join('');
                lucide.createIcons();
            }
        }

        window.populatePayers = () => {
            const select = document.getElementById('exp-payer');
            if (select) {
                select.innerHTML = appData.members.map(m => `<option value="${m}">${m}</option>`).join('');
            }
        }

        window.populateMembers = () => {
            const container = document.getElementById('exp-members');
            if (container) {
                container.innerHTML = appData.members.map(m => `
                    <label class="flex items-center gap-3 bg-black/40 p-3 rounded-xl cursor-pointer border border-transparent hover:border-zinc-600 transition">
                        <input type="checkbox" value="${m}" checked class="custom-checkbox w-5 h-5">
                        <span class="text-xs text-zinc-300 font-bold font-zh">${m}</span>
                    </label>
                `).join('');
            }
        }

        window.updateDashboard = () => {
            const myName = localStorage.getItem('korea_travel_me');
            const greetingNameEl = document.getElementById('greeting-name');
            
            if(greetingNameEl) {
                if(myName) {
                     greetingNameEl.innerText = myName;
                } else {
                     greetingNameEl.innerText = (appData.members && appData.members.length > 0 ? appData.members[0] : "旅人");
                }
            }

            let next = null;
            let nextDate = ""; 
            if (appData.itinerary) {
                const dates = Object.keys(appData.itinerary).sort();
                for(let d of dates) {
                    if(appData.itinerary[d] && appData.itinerary[d].length > 0) { 
                        next = appData.itinerary[d][0]; 
                        nextDate = d; 
                        break; 
                    }
                }
            }
            const nextEl = document.getElementById("dash-next-event");
            const nextTimeEl = document.getElementById("dash-next-time");
            
            if (nextEl) {
                if(next) {
                    nextEl.innerText = next.title;
                    nextEl.dataset.korAddr = next.korAddr || ""; 
                    nextEl.dataset.title = next.title;
                    nextEl.dataset.korTitle = next.korTitle || "";
                    
                    const datePart = nextDate.split('-').slice(1).join('/');
                    if(nextTimeEl) nextTimeEl.innerText = `${datePart} ${next.time}`;
                } else {
                    nextEl.innerText = "暫無行程";
                    if(nextTimeEl) nextTimeEl.innerText = "--:--";
                }
            }
        };

        window.renderItinerary = () => {
            const dateTabs = document.getElementById('date-tabs');
            if (dateTabs && appData.itinerary) {
                const sortedDates = Object.keys(appData.itinerary).sort();
                dateTabs.innerHTML = sortedDates.map(date => {
                    const day = date.split('-')[2];
                    const active = date === currentDay;
                    // 修正：按鈕高度改為 h-[50px]
                    const style = active ? 'bg-[#D4AF37] text-black font-bold ring-4 ring-[#D4AF37]/20 shadow-[0_0_20px_rgba(212,175,55,0.4)] scale-105' : 'bg-zinc-900/40 text-zinc-500 border border-zinc-800 hover:bg-zinc-800/80 hover:text-zinc-300';
                    return `<button onclick="setDay('${date}')" class="transition-all duration-300 w-12 h-[50px] rounded-2xl flex flex-col items-center justify-center gap-0.5 ${style}">
                            <span class="text-[9px] tracking-widest font-zh opacity-80">3月</span><span class="text-xl leading-none font-bold font-num">${day}</span></button>`;
                }).join('');
            }

            const list = document.getElementById('itinerary-list');
            if (!list) return;
            const events = (appData.itinerary && appData.itinerary[currentDay]) ? appData.itinerary[currentDay] : [];
            if(events.length === 0) {
                list.innerHTML = `<div class="text-zinc-600 text-sm italic pl-4 pt-8 tracking-widest font-bold font-zh">本日無行程，請點擊下方 + 新增</div>`;
                return;
            }
            list.innerHTML = events.map((e, i) => `
                <div class="relative pl-0 pb-8 group fade-in event-item" data-id="${i}">
                    <div class="glass rounded-[2rem] p-5 border border-white/5 relative overflow-hidden active:scale-[0.99] transition-transform shadow-lg group-hover:border-[#D4AF37]/30 transition-colors duration-500">
                        <div class="flex justify-between items-start mb-1 relative z-10">
                            <span class="text-[#D4AF37] text-sm tracking-widest font-bold font-num">${e.time}</span>
                            <button onclick="openEditEvent(${i})" class="text-zinc-600 hover:text-white transition cursor-pointer p-2 -mr-3 -mt-3">
                                <i data-lucide="pencil" size="16"></i>
                            </button>
                        </div>
                        <h3 class="text-white text-lg tracking-wide mb-1 font-bold relative z-10 font-zh">${e.title}</h3>
                        ${e.korTitle ? `<div class="text-zinc-500 text-xs font-kr mb-3 font-medium tracking-wide">${e.korTitle}</div>` : ''}
                        ${e.memo ? `<div class="bg-black/30 p-3 rounded-xl text-zinc-400 text-sm leading-relaxed mb-3 border-l-[3px] border-zinc-700 whitespace-pre-wrap font-zh font-medium">${window.autoLink(e.memo)}</div>` : ''}
                        
                        <div class="flex gap-3 mt-2 relative z-10">
                             ${e.korTitle ? `
                             <button onclick="openTaxiMode('${e.title}', '${e.korTitle}', '${e.korAddr}')" class="flex-1 bg-[#D4AF37]/10 border border-[#D4AF37]/30 text-[#D4AF37] py-3 rounded-xl text-xs font-bold flex items-center justify-center gap-1.5 hover:bg-[#D4AF37] hover:text-black transition">
                                <i data-lucide="car-front" size="16"></i> <span class="font-en">TAXI</span>
                             </button>` : ''}
                             <button onclick="openNaverMap('${e.korAddr || e.title}')" class="flex-1 bg-zinc-900 border border-zinc-800 text-zinc-400 py-3 rounded-xl text-xs flex items-center justify-center gap-1.5 hover:bg-zinc-800 hover:text-white transition font-bold">
                                <i data-lucide="map" size="16"></i> <span class="font-en">MAP</span>
                             </button>
                        </div>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
            new Sortable(list, {
                animation: 150, delay: 200, delayOnTouchOnly: true,
                onEnd: function (evt) {
                    const movedItem = appData.itinerary[currentDay].splice(evt.oldIndex, 1)[0];
                    appData.itinerary[currentDay].splice(evt.newIndex, 0, movedItem);
                    saveDataToFirebase();
                },
            });
        };

        window.renderPacking = () => {
            const list = document.getElementById('packing-list');
            if (!list) return;
            const total = appData.packing ? appData.packing.length : 0;
            const checked = appData.packing ? appData.packing.filter(i => i.checked).length : 0;
            const pct = total === 0 ? 0 : Math.round((checked/total)*100);
            
            const packPercentEl = document.getElementById('pack-percent');
            if (packPercentEl) packPercentEl.innerText = `${pct}%`;
            
            const packRing = document.getElementById('pack-ring');
            if(packRing) {
                const offset = 264 - (264 * pct / 100);
                packRing.style.strokeDashoffset = offset;
            }

            const cats = [...new Set((appData.packing || []).map(i => i.cat))];
            list.innerHTML = cats.map(cat => {
                const items = appData.packing.filter(i => i.cat === cat);
                const html = items.map(item => `
                    <div class="flex items-center justify-between py-3.5 border-b border-white/5 last:border-0 group ${item.checked ? 'opacity-40' : 'opacity-100'} transition-opacity duration-300">
                        <label class="flex items-center gap-4 cursor-pointer w-full">
                            <input type="checkbox" ${item.checked ? 'checked' : ''} onchange="togglePack(${item.id})" class="custom-checkbox w-5 h-5">
                            <span class="${item.checked ? 'line-through decoration-zinc-500' : ''} text-sm text-zinc-200 font-bold font-zh">${item.name}</span>
                        </label>
                        <button onclick="deletePack(${item.id})" class="text-zinc-600 hover:text-red-500 transition"><i data-lucide="minus-circle" size="18"></i></button>
                    </div>
                `).join('');
                return `<div class="glass rounded-[2rem] p-5 mb-4 border border-white/5 bg-black/20"><h4 class="text-[10px] text-[#D4AF37] tracking-[0.25em] mb-4 font-bold font-zh flex items-center gap-3"><span class="w-1.5 h-1.5 rounded-full bg-[#D4AF37]"></span>${cat}</h4><div>${html}</div></div>`;
            }).join('');
            lucide.createIcons();
        };

        window.renderExpenses = () => {
            const list = document.getElementById('expense-list');
            if (!list) return; 
            let total = 0;
            let balances = {}; 
            if (appData.members) { appData.members.forEach(m => balances[m] = 0); }
            const expenses = appData.expenses || [];
            list.innerHTML = expenses.map((e, i) => {
                total += Number(e.amount);
                const share = e.amount / (e.members ? e.members.length : 1);
                if(balances[e.payer] !== undefined) balances[e.payer] += Number(e.amount);
                if(e.members) { e.members.forEach(m => { if(balances[m] !== undefined) balances[m] -= share; }); }
                return `
                    <div onclick="openExpenseDetail(${i})" class="flex justify-between items-center py-4 border-b border-white/5 last:border-0 hover:bg-white/5 px-3 rounded-xl transition group cursor-pointer active:scale-98">
                        <div class="flex items-center gap-3 flex-1 min-w-0 mr-2">
                            <div class="flex-shrink-0 w-9 h-9 rounded-full bg-zinc-800 flex items-center justify-center text-xs font-bold text-zinc-400 border border-white/5 font-zh group-hover:border-[#D4AF37]/50 transition">${e.payer[0]}</div>
                            <div class="min-w-0">
                                <div class="text-zinc-200 text-sm font-bold truncate font-zh">${e.desc}</div>
                                <div class="text-[10px] text-zinc-500 mt-0.5 font-bold truncate font-zh">付款: ${e.payer}</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-3 flex-shrink-0">
                            <div class="text-zinc-300 text-sm font-bold font-num tracking-tight">NT$ ${Number(e.amount).toLocaleString()}</div>
                            <i data-lucide="chevron-right" size="14" class="text-zinc-600"></i>
                        </div>
                    </div>
                `;
            }).join('');
            lucide.createIcons();
            const totalExpenseEl = document.getElementById('total-expense');
            if (totalExpenseEl) totalExpenseEl.innerText = `NT$ ${total.toLocaleString()}`;
            let html = '';
            Object.keys(balances).forEach(p => {
                const val = Math.round(balances[p]);
                if(val > 0) html += `<div class="flex justify-between text-emerald-400/90 text-xs py-2 border-b border-zinc-800/50"><span class="font-bold font-zh text-zinc-400">${p}</span><span class="font-bold font-num tracking-wide">應收 $${val.toLocaleString()}</span></div>`;
                else if(val < 0) html += `<div class="flex justify-between text-rose-400/90 text-xs py-2 border-b border-zinc-800/50"><span class="font-bold font-zh text-zinc-400">${p}</span><span class="font-bold font-num tracking-wide">應付 $${Math.abs(val).toLocaleString()}</span></div>`;
            });
            const splitResultEl = document.getElementById('split-result');
            if (splitResultEl) { splitResultEl.innerHTML = html || "<span class='text-zinc-600 italic font-zh text-[10px]'>暫無帳務紀錄</span>"; }
        };

        window.renderAll = () => {
            updateDashboard();
            renderItinerary();
            renderPacking();
            renderExpenses();
            renderMembers();
            const memoArea = document.getElementById('global-memo');
            if(memoArea && document.activeElement !== memoArea) {
                memoArea.value = appData.memo || "";
            }
        };

        document.getElementById('global-memo').addEventListener('input', (e) => {
            appData.memo = e.target.value;
            saveDataToFirebase();
        });

        init();
    </script>

    <!-- UI Scripts -->
    <script>
        function openTaxiMode(title, korTitle, korAddr) {
            // Populate
            document.getElementById('taxi-kor-title').innerText = korTitle || title;
            document.getElementById('taxi-kor-addr').innerText = korAddr || "地址未設定";
            
            // Show Overlay
            const overlay = document.getElementById('taxi-overlay');
            overlay.classList.remove('hidden');
            overlay.classList.add('flex');
            
            // Wait slightly for display change, then fade in opacity
            setTimeout(() => {
                overlay.classList.remove('opacity-0');
            }, 10);
        }

        function closeTaxiMode() {
            const overlay = document.getElementById('taxi-overlay');
            overlay.classList.add('opacity-0');
            
            // Wait for transition to finish before hiding
            setTimeout(() => {
                overlay.classList.remove('flex');
                overlay.classList.add('hidden');
            }, 300);
        }

        function openNaverMap(query) {
            if(!query) return;
            window.open(`https://map.naver.com/p/search/${encodeURIComponent(query)}`, '_blank');
        }
        function quickTaxi() {
            const el = document.getElementById("dash-next-event");
            if(el.innerText !== "暫無行程" && el.dataset.korTitle) {
                openTaxiMode(el.dataset.title, el.dataset.korTitle, el.dataset.korAddr);
            } else {
                alert("下一個行程沒有韓文資訊，無法開啟計程車模式");
            }
        }
        function quickMap() {
            const el = document.getElementById("dash-next-event");
            if(el.innerText !== "暫無行程") {
                openNaverMap(el.dataset.korAddr || el.dataset.title);
            }
        }
        function switchTab(tabId, btn) {
            document.querySelectorAll('.tab-content').forEach(el => {
                if(el.id !== tabId) {
                    el.classList.remove('active');
                    setTimeout(() => { if(!el.classList.contains('active')) el.style.display = 'none'; }, 200);
                }
            });
            const target = document.getElementById(tabId);
            target.style.display = 'block';
            void target.offsetWidth; 
            target.classList.add('active');

            document.querySelectorAll('.nav-btn').forEach(el => {
                el.classList.remove('text-[#D4AF37]');
                el.classList.add('text-zinc-600');
                const label = el.querySelector('span');
                if(label) label.classList.remove('scale-110', 'text-white');
            });
            if(btn) {
                btn.classList.remove('text-zinc-600');
                btn.classList.add('text-[#D4AF37]');
                const label = btn.querySelector('span');
                if(label) label.classList.add('scale-110', 'text-white');
            }
            document.getElementById('main-container').scrollTo({ top: 0, behavior: 'smooth' });
        }
        function toggleSettlement() { document.getElementById('settlement-view').classList.toggle('hidden'); }
        
        function openActionSheet() {
            const sheet = document.getElementById('action-sheet');
            const overlay = document.getElementById('action-sheet-overlay');
            overlay.classList.remove('hidden');
            void overlay.offsetWidth;
            overlay.classList.remove('opacity-0');
            sheet.classList.remove('translate-y-full');
        }
        function closeActionSheet() {
            const sheet = document.getElementById('action-sheet');
            const overlay = document.getElementById('action-sheet-overlay');
            sheet.classList.add('translate-y-full');
            overlay.classList.add('opacity-0');
            setTimeout(() => overlay.classList.add('hidden'), 300);
        }
        function openSubModal(id, skipClear) {
            closeActionSheet();
            if (!skipClear) {
                if(id === 'modal-expense') {
                    window.populateMembers();
                    window.populatePayers(); 
                }
                if(id === 'modal-members') window.renderMembers();
            }
            setTimeout(() => {
                document.getElementById('modal-container').classList.remove('hidden');
                document.querySelectorAll('#modal-container > div').forEach(d => d.classList.add('hidden'));
                document.getElementById(id).classList.remove('hidden');
            }, 300);
        }
        function closeSubModal() { document.getElementById('modal-container').classList.add('hidden'); }
    </script>
</body>
</html>


